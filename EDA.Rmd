---
title: "EDA"
author: "Ivan Kostine, Niccolo Cherubini, Charl√®ne Khairallah"
date: "`r format(Sys.time(), '%d-%m-%Y')`"
output: 
  html_document:
    theme: cosmo
    highlight: rstudio
    toc: true
    toc_float: true
    code_folding: hide
---

```{r import_data}
knitr::opts_chunk$set(echo = TRUE)
library(tidyr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(readxl)
library(lubridate)
library(DataExplorer)
library(corrplot)
library(GGally)
library(DT)

#web scrapping
library(rvest)

#cleaning 
library(summarytools)
library(imputeTS)

#Forecasting 
library(tsibble)
library(fpp3)
library(ggfortify)

wd = getwd()
cat("Current working directory: ",wd)
setwd(wd)

COT_Cotton<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Cotton") %>% as_tsibble(index= Date, regular=FALSE)
COT_Cocoa<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Cocoa") %>% as_tsibble(index= Date, regular=FALSE)
COT_Silver<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Silver") %>% as_tsibble(index= Date, regular=FALSE)

```


```{r, echo=FALSE, message=FALSE}
COT_Cotton %>% select("Producer/Merchant/Processor/User Shorts") %>% autoplot() + labs(title = "COT Cotton", x = "Date", y = "Number of positions") 
COT_Cocoa %>% select("Producer/Merchant/Processor/User Shorts") %>% autoplot() + labs(title = "COT Cocoa", x = "Date", y = "Number of positions") 
COT_Silver %>% select("Producer/Merchant/Processor/User Shorts") %>% autoplot() + labs(title = "COT Silver", x = "Date", y = "Number of positions") 

ShortLongCotton <- COT_Cotton %>% select("Date", "Producer/Merchant/Processor/User Shorts", "Producer/Merchant/Processor/User Longs") %>% gather(key = "Variable", value = "value", -Date)

ShortLongCocoa <- COT_Cocoa %>% select("Date", "Producer/Merchant/Processor/User Shorts", "Producer/Merchant/Processor/User Longs") %>% gather(key = "Variable", value = "value", -Date)

ShortLongSilver <- COT_Silver %>% select("Date", "Producer/Merchant/Processor/User Shorts", "Producer/Merchant/Processor/User Longs") %>% gather(key = "Variable", value = "value", -Date)

ggplot(ShortLongCotton, aes(x = Date, y = value)) + 
  geom_line(aes(color = Variable)) + 
  scale_color_manual(values = c("darkred", "darkblue")) +
  labs(title="Producer Longs vs. Shorts - Cotton")

ggplot(ShortLongCocoa, aes(x = Date, y = value)) + 
  geom_line(aes(color = Variable)) + 
  scale_color_manual(values = c("darkred", "darkblue")) +
  labs(title="Producer Longs vs. Shorts - Cocoa")

ggplot(ShortLongSilver, aes(x = Date, y = value)) + 
  geom_line(aes(color = Variable)) + 
  scale_color_manual(values = c("darkred", "darkblue")) +
  labs(title="Producer Longs vs. Shorts - Silver")

```
```{r createDF}
commodity_dfs = list()
sheets = excel_sheets(path="./data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx")
for ( i in 1:length(sheets)){
  tempdf = read_excel("./data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet=sheets[i])
  commodity_dfs[[i]] = tempdf
}

```



```{r}

```

```{r longs vs. shorts }

for (i in 1:length(commodity_dfs)){
  current = commodity_dfs[[i]] %>% as_tibble(index=Date, regular=FALSE) 
  currentplot <- current %>% 
    select("Date", "Producer/Merchant/Processor/User Shorts", "Producer/Merchant/Processor/User Longs") %>% 
    gather(key = "Variable", value = "value", -Date)
  
  plot = ggplot(currentplot, aes(x = Date, y = value)) + 
    geom_line(aes(color = Variable)) + 
    scale_color_manual(values = c("darkred", "darkblue")) +
    labs(title=str_glue('Producer Longs vs. Shorts - {sheets[i]}'))
  print(plot)
}


```


```{r}
# Libraries
library(ggplot2)
library(dplyr)
library(plotly)
library(hrbrthemes)

# Usual area chart
COI <- COT_Cocoa %>%
  ggplot( aes(x=Date, y= `Open Interest`)) +
    geom_area(fill="#69b3a2", alpha=0.5) +
    geom_line(color="#69b3a2") +
    ylab("Open interest of cocoa") +
    theme_ipsum()

# Turn it interactive with ggplotly
COI <- ggplotly(COI)
COI

```
```{r}
# Load required libraries
library(dygraphs)
library(xts)

# Create xts object from your data
PLS <- xts(data.frame(
  date = COT_Cocoa$Date,  
  producer_short = COT_Cocoa$`Producer/Merchant/Processor/User Longs`, 
  producer_long = COT_Cocoa$`Producer/Merchant/Processor/User Shorts`), order.by = COT_Cocoa$Date)

# Create dygraph
P <- dygraph(PLS)
P

```




