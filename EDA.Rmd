---
title: "EDA"
author: "Ivan Kostine, Niccolo Cherubini, Charl√®ne Khairallah"
date: "`r format(Sys.time(), '%d-%m-%Y')`"
output: 
  html_document:
    theme: cosmo
    highlight: rstudio
    toc: true
    toc_float: true
    code_folding: hide
---

```{r import_data}
knitr::opts_chunk$set(echo = TRUE)
library(tidyr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(readxl)
library(lubridate)
library(DataExplorer)
library(corrplot)
library(GGally)
library(DT)

#web scrapping
library(rvest)

#cleaning 
library(summarytools)
library(imputeTS)

#Forecasting 
library(tsibble)
library(fpp3)
library(ggfortify)

wd = getwd()
cat("Current working directory: ",wd)
setwd(wd)

COT_Cotton<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Cotton") %>% as_tsibble(index= Date, regular=FALSE)
COT_Cocoa<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Cocoa") %>% as_tsibble(index= Date, regular=FALSE)
COT_Silver<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Silver") %>% as_tsibble(index= Date, regular=FALSE)
COT_CrudeOil<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="CrudeOil") %>% as_tsibble(index= Date, regular=FALSE)
COT_Sugar<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Sugar") %>% as_tsibble(index= Date, regular=FALSE)
COT_NagGas<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="NagGas") %>% as_tsibble(index= Date, regular=FALSE)
COT_HeatOil<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="HeatOil") %>% as_tsibble(index= Date, regular=FALSE)
COT_Gasoline<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Gasoline") %>% as_tsibble(index= Date, regular=FALSE)
COT_Corn<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Corn") %>% as_tsibble(index= Date, regular=FALSE)
COT_Soybeans<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Soybeans") %>% as_tsibble(index= Date, regular=FALSE)
COT_SoyOil<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="SoyOil") %>% as_tsibble(index= Date, regular=FALSE)
COT_SoyMeal<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="SoyMeal") %>% as_tsibble(index= Date, regular=FALSE)
COT_Wheat<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Wheat") %>% as_tsibble(index= Date, regular=FALSE)
COT_Gold<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Gold") %>% as_tsibble(index= Date, regular=FALSE)
COT_Platinum<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Platinum") %>% as_tsibble(index= Date, regular=FALSE)
COT_Palladium<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Palladium") %>% as_tsibble(index= Date, regular=FALSE)
COT_FedCattle<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="FedCattle") %>% as_tsibble(index= Date, regular=FALSE)
COT_LiveCattle<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="LiveCattle") %>% as_tsibble(index= Date, regular=FALSE)
COT_LeanHogs<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="LeanHogs") %>% as_tsibble(index= Date, regular=FALSE)
COT_Copper<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Copper") %>% as_tsibble(index= Date, regular=FALSE)
COT_Coffee<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Coffee") %>% as_tsibble(index= Date, regular=FALSE)



```

```{r}
library(readxl)
library(tsibble)

# Create an empty list to store the data frames
commodity_data_list <- list()

# List of commodity sheet names
commodities <- c(
  "Cotton", "Cocoa", "Silver", "CrudeOil", "Sugar", "NagGas", "HeatOil",
  "Gasoline", "Corn", "Soybeans", "SoyOil", "SoyMeal", "Wheat", "Gold",
  "Platinum", "Palladium", "FedCattle", "LiveCattle", "LeanHogs","Copper", "Coffee"
)

# Load data for each commodity and store it in the list
for (commodity in commodities) {
  data <- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet = commodity) %>%
    as_tsibble(index = Date, regular = FALSE)
  commodity_data_list[[commodity]] <- data
}

# Now you have a list 'commodity_data_list' containing data frames for each commodity

```



```{r}
library(ggplot2)
library(dplyr)
library(plotly)
library(hrbrthemes)

# Create and display interactive area charts for "Open Interest" for each commodity
for (commodity_name in names(commodity_data_list)) {
  current_data <- commodity_data_list[[commodity_name]]
  
  open_interest_chart <- current_data %>%
    ggplot(aes(x = Date, y = `Open Interest`)) +
    geom_area(fill = "#69b3a2", alpha = 0.5) +
    geom_line(color = "#69b3a2") +
    ylab(paste("Open Interest of", commodity_name)) +
    theme_ipsum()
    
  interactive_area_chart <- ggplotly(open_interest_chart)
  
  # Display the interactive area chart
  print(interactive_area_chart)
}


```


```{r}
library(dygraphs)
library(xts)

# Create dygraph for each commodity in commodity_data_list
for (commodity_name in names(commodity_data_list)) {
  current_data <- commodity_data_list[[commodity_name]]
  
  # Create xts object from your data
  PLS <- xts(current_data, order.by = current_data$Date)
  
  # Create dygraph
  P <- dygraph(PLS, main = paste(commodity_name))
  
  # Display the dygraph
  print(P)
}


```

Plots for each variables of each commodities
```{r}

library(ggplot2)


# Create and display time series plots for each data frame in the list
for (i in 1:length(commodity_data_list)) {
  current_data <- commodity_data_list[[i]]
  commodity_name <- names(commodity_data_list)[i]  # Get the name of the commodity
  
  COT_data_long <- gather(current_data, key = "Variable", value = "Value", -Date)
  
  plotTimeseries <- ggplot(data = COT_data_long, aes(x = Date, y = Value)) +
    geom_line() +
    facet_wrap(~Variable, scales = "free_y") +
    labs(
      title = paste("Time Series Plots for COT", commodity_name),  # Include commodity name in the title
      x = "Date",
      y = "Value"
    )
  
  print(plotTimeseries)
}



```



```{r}
library(dygraphs)
library(xts)

# Create dygraph for each commodity in commodity_data_list
for (commodity_name in names(commodity_data_list)) {
  current_data <- commodity_data_list[[commodity_name]]
  
  # Create xts object with selected variables
  PLS <- xts(data.frame(
    Date = current_data$Date,
    producer_short = current_data$`Producer/Merchant/Processor/User Longs`,
    producer_long = current_data$`Producer/Merchant/Processor/User Shorts`
  ), order.by = current_data$Date)
  
  # Create dygraph
  P <- dygraph(PLS, main = paste("Producer Longs vs. Shorts -", commodity_name))
  
  # Display the dygraph
  print(P)
}

```



```{r}

# Define a function to categorize commodities
categorize_commodity <- function(commodity_name) {
  if (commodity_name %in% c("Cotton", "Coffee", "Sugar", "Cocoa", "Corn", "SoyBeans", "SoyOil", "SoyMeal", "Wheat", "LeanHogs")) {
    return("Agricultural Commodities")
  } else if (commodity_name %in% c("FedCattle", "LiveCattle", "LeanHogs")) {
    return("Livestock")
  } else if (commodity_name %in% c("Copper", "Gold", "Silver", "Platinum", "Palladium")) {
    return("Metals")
  } else if (commodity_name %in% c("CrudeOil", "NagGas", "HeatOil","Gasoline")) {
    return("Energy Commodities")
  } else {
    return("Other")
  }
}

# Create a list to store correlation matrices
correlation_matrices <- list()

# Loop through the data frames
for (commodity_name in names(commodity_data_list)) {
  # Categorize the commodity
  category <- categorize_commodity(commodity_name)
  
  # Identify which columns are numeric (excluding the "Date" column)
  numeric_columns <- sapply(commodity_data_list[[commodity_name]], function(col) is.numeric(col) && !identical(col, commodity_data_list[[commodity_name]]$Date))
  
  # Select and calculate the correlation matrix for numeric columns
  numeric_data <- commodity_data_list[[commodity_name]][, numeric_columns]
  
  # Check if there are enough numeric columns for correlation analysis
  if (sum(numeric_columns) >= 2) {
    correlation_matrix <- cor(numeric_data)
    
    # Store the correlation matrix in the list with the category as the name
    correlation_matrices[[category]] <- correlation_matrix
  } else {
    cat("Insufficient numeric columns for correlation analysis in", commodity_name, "\n")
  }
}

# Visualize correlations for each category
for (category in names(correlation_matrices)) {
  cat("\nCategory:", category)
  corrplot(correlation_matrices[[category]], method = "color", type = "lower", tl.col = "black", title = "Correlation Heatmap")
}


```

```{r}
# Define a function to categorize commodities
categorize_commodity <- function(commodity_name) {
  if (commodity_name %in% c("Cotton", "Coffee", "Sugar", "Cocoa", "Corn", "SoyBeans", "SoyOil", "SoyMeal", "Wheat", "LeanHogs")) {
    return("Agricultural Commodities")
  } else if (commodity_name %in% c("FedCattle", "LiveCattle", "LeanHogs")) {
    return("Livestock")
  } else if (commodity_name %in% c("Copper", "Gold", "Silver", "Platinum", "Palladium")) {
    return("Metals")
  } else if (commodity_name %in% c("CrudeOil", "NagGas", "HeatOil", "Gasoline")) {
    return("Energy Commodities")
  } else {
    return("Other")
  }
}

# Create a list to store correlation matrices for each category
correlation_matrices <- list(
  "Agricultural Commodities" = NULL,
  "Livestock" = NULL,
  "Metals" = NULL,
  "Energy Commodities" = NULL
)

# Loop through the data frames
for (commodity_name in names(commodity_data_list)) {
  # Categorize the commodity
  category <- categorize_commodity(commodity_name)
  
  # Identify which columns are numeric (excluding the "Date" column)
  numeric_columns <- sapply(commodity_data_list[[commodity_name]], function(col) is.numeric(col) && !identical(col, commodity_data_list[[commodity_name]]$Date))
  
  # Select and calculate the correlation matrix for numeric columns
  numeric_data <- commodity_data_list[[commodity_name]][, numeric_columns]
  
  # Check if there are enough numeric columns for correlation analysis
  if (sum(numeric_columns) >= 2) {
    correlation_matrix <- cor(numeric_data)
    
    # Store the correlation matrix in the list under the appropriate category
    correlation_matrices[[category]] <- rbind(correlation_matrices[[category]], correlation_matrix)
  } else {
    cat("Insufficient numeric columns for correlation analysis in", commodity_name, "\n")
  }
}

# Visualize correlations for each category
for (category in names(correlation_matrices)) {
  cat("\nCategory:", category)
  corrplot(correlation_matrices[[category]], method = "color", type = "lower", tl.col = "black", title = "Correlation Heatmap")
}

```


```{r}

library(xts)

# Create and display 10-day moving average plots for each commodity
for (commodity_name in names(commodity_data_list)) {
  current_data <- commodity_data_list[[commodity_name]]
  
  # Calculate the 10-day moving average
  current_data$MA <- zoo::rollmean(current_data$`Open Interest`, k = 10, fill = NA)
  
  # Create xts object
  xts_data <- xts(current_data, order.by = current_data$Date)
  
  # Plot the 10-day moving average
  plot(xts_data$Date, xts_data$MA, type = "l", xlab = "Date", ylab = "10-Day Moving Average", main = paste("10-Day Moving Average -", commodity_name))
}



```







