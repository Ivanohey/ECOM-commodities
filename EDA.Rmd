---
title: "EDA"
author: "Ivan Kostine, Niccolo Cherubini, Charl√®ne Khairallah"
date: "`r format(Sys.time(), '%d-%m-%Y')`"
output: 
  html_document:
    theme: cosmo
    highlight: rstudio
    toc: true
    toc_float: true
    code_folding: hide
---

```{r import_data}
knitr::opts_chunk$set(echo = TRUE)
library(tidyr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(readxl)
library(lubridate)
library(DataExplorer)
library(corrplot)
library(GGally)
library(DT)

#web scrapping
library(rvest)

#cleaning 
library(summarytools)
library(imputeTS)

#Forecasting 
library(tsibble)
library(fpp3)
library(ggfortify)

#Modelling
library(reshape2)
library(plotly)
library(hrbrthemes)

library(dygraphs)
library(xts)

wd = getwd()
cat("Current working directory: ",wd)
setwd(wd)

COT_Cotton<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Cotton") %>% as_tsibble(index= Date, regular=FALSE)
COT_Cocoa<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Cocoa") %>% as_tsibble(index= Date, regular=FALSE)
COT_Silver<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Silver") %>% as_tsibble(index= Date, regular=FALSE)
COT_CrudeOil<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="CrudeOil") %>% as_tsibble(index= Date, regular=FALSE)
COT_Sugar<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Sugar") %>% as_tsibble(index= Date, regular=FALSE)
COT_NagGas<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="NagGas") %>% as_tsibble(index= Date, regular=FALSE)
COT_HeatOil<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="HeatOil") %>% as_tsibble(index= Date, regular=FALSE)
COT_Gasoline<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Gasoline") %>% as_tsibble(index= Date, regular=FALSE)
COT_Corn<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Corn") %>% as_tsibble(index= Date, regular=FALSE)
COT_Soybeans<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Soybeans") %>% as_tsibble(index= Date, regular=FALSE)
COT_SoyOil<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="SoyOil") %>% as_tsibble(index= Date, regular=FALSE)
COT_SoyMeal<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="SoyMeal") %>% as_tsibble(index= Date, regular=FALSE)
COT_Wheat<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Wheat") %>% as_tsibble(index= Date, regular=FALSE)
COT_Gold<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Gold") %>% as_tsibble(index= Date, regular=FALSE)
COT_Platinum<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Platinum") %>% as_tsibble(index= Date, regular=FALSE)
COT_Palladium<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Palladium") %>% as_tsibble(index= Date, regular=FALSE)
COT_FedCattle<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="FedCattle") %>% as_tsibble(index= Date, regular=FALSE)
COT_LiveCattle<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="LiveCattle") %>% as_tsibble(index= Date, regular=FALSE)
COT_LeanHogs<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="LeanHogs") %>% as_tsibble(index= Date, regular=FALSE)
COT_Copper<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Copper") %>% as_tsibble(index= Date, regular=FALSE)
COT_Coffee<- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet="Coffee") %>% as_tsibble(index= Date, regular=FALSE)



```

```{r}
# Create an empty list to store the data frames
commodity_data_list <- list()

# List of commodity sheet names
commodities <- c(
  "Cotton", "Cocoa", "Silver", "CrudeOil", "Sugar", "NagGas", "HeatOil",
  "Gasoline", "Corn", "Soybeans", "SoyOil", "SoyMeal", "Wheat", "Gold",
  "Platinum", "Palladium", "FedCattle", "LiveCattle", "LeanHogs","Copper", "Coffee"
)

# Load data for each commodity and store it in the list
for (commodity in commodities) {
  data <- read_excel("data/COT_Disaggreated_FuturesAndOptionsCombined.xlsx", sheet = commodity) %>% rename(
    "Open_Interest" = "Open Interest",
    "Producer_Longs"="Producer/Merchant/Processor/User Longs",
    "Producer_Shorts"="Producer/Merchant/Processor/User Shorts",
    "Swap_Dealer_Longs"="Swap Dealer Longs",
    "Swap_Dealer_Shorts"="Swap Dealer Shorts",
    "Swap_Dealer_Spreads"="Swap Dealer Spreads",
    "Money_Manager_Longs"="Money Manager Longs",
    "Money_Manager_Shorts"="Money Manager Shorts",
    "Money_Manager_Spreads"="Money Manager Spreads",
    "Other_Reportable_Longs"="Other Reportable Longs",
    "Other_Reportable_Shorts"="Other Reportable Shorts",
    "Other_Reportable_Shorts"="Other Reportable Shorts",
    "Total_Reportable_Longs"="Total Reportable Longs",
    "Total_Reportable_Shorts"="Total Reportable Shorts",
    "Non_Reportable_Longs"="Non Reportable Longs",
    "Non_Reportable_Shorts"="Non Reportable Shorts") %>% as_tsibble(index = Date, regular = FALSE)
  commodity_data_list[[commodity]] <- data
}

# Now you have a list 'commodity_data_list' containing data frames for each commodity

```



```{r}
# Create and display interactive area charts for "Open Interest" for each commodity
for (commodity_name in names(commodity_data_list)) {
  current_data <- commodity_data_list[[commodity_name]]
  
  open_interest_chart <- current_data %>%
    ggplot(aes(x = Date, y = `Open_Interest`)) +
    ggtitle(paste("Open interest of ", commodity_name))+
    geom_area(fill = "#69b3a2", alpha = 0.5) +
    geom_line(color = "#69b3a2") +
    ylab("Open Interest") +
    theme_ipsum()
    
  interactive_area_chart <- ggplotly(open_interest_chart)
  
  # Display the interactive area chart
  print(interactive_area_chart)
}


```

From the following dygraphs, we can see that Open interest, total reportable shorts and total reportable longs are highly correlated.

```{r}

# Create dygraph for each commodity in commodity_data_list
for (commodity_name in names(commodity_data_list)) {
  current_data <- commodity_data_list[[commodity_name]]
  
  # Create xts object from your data
  PLS <- xts(current_data, order.by = current_data$Date)
  
  # Create dygraph
  P <- dygraph(PLS, main = paste(commodity_name))
  
  # Display the dygraph
  print(P)
}


```

Plots for each variables of each commodities
```{r}
# Create and display time series plots for each data frame in the list
for (i in 1:length(commodity_data_list)) {
  current_data <- commodity_data_list[[i]]
  commodity_name <- names(commodity_data_list)[i]  # Get the name of the commodity
  
  COT_data_long <- gather(current_data, key = "Variable", value = "Value", -Date)
  
  plotTimeseries <- ggplot(data = COT_data_long, aes(x = Date, y = Value)) +
    geom_line() +
    facet_wrap(~Variable, scales = "free_y") +
    labs(
      title = paste("Time Series Plots for COT", commodity_name),  # Include commodity name in the title
      x = "Date",
      y = "Value"
    )
  
  print(plotTimeseries)
}


```



```{r}
# Create dygraph for each commodity in commodity_data_list
for (commodity_name in names(commodity_data_list)) {
  current_data <- commodity_data_list[[commodity_name]]
  
  # Create xts object with selected variables
  PLS <- xts(data.frame(
    Date = current_data$Date,
    producer_short = current_data$`Producer_Longs`,
    producer_long = current_data$`Producer_Shorts`
  ), order.by = current_data$Date)
  
  # Create dygraph
  P <- dygraph(PLS, main = paste("Producer Longs vs. Shorts -", commodity_name))
  
  # Display the dygraph
  print(P)
}

```



```{r}
# Define a function to categorize commodities
categorize_commodity <- function(commodity_name) {
  if (commodity_name %in% c("Cotton", "Coffee", "Sugar", "Cocoa", "Corn", "SoyBeans", "SoyOil", "SoyMeal", "Wheat", "LeanHogs")) {
    return("Agricultural Commodities")
  } else if (commodity_name %in% c("FedCattle", "LiveCattle", "LeanHogs")) {
    return("Livestock")
  } else if (commodity_name %in% c("Copper", "Gold", "Silver", "Platinum", "Palladium")) {
    return("Metals")
  } else if (commodity_name %in% c("CrudeOil", "NagGas", "HeatOil","Gasoline")) {
    return("Energy Commodities")
  } else {
    return("Other")
  }
}

# Create a list to store correlation matrices
correlation_matrices <- list()

# Loop through the data frames
for (commodity_name in names(commodity_data_list)) {
  # Categorize the commodity
  category <- categorize_commodity(commodity_name)
  
  # Identify which columns are numeric (excluding the "Date" column)
  numeric_columns <- sapply(commodity_data_list[[commodity_name]], function(col) is.numeric(col) && !identical(col, commodity_data_list[[commodity_name]]$Date))
  
  # Select and calculate the correlation matrix for numeric columns
  numeric_data <- commodity_data_list[[commodity_name]][, numeric_columns]
  
  # Check if there are enough numeric columns for correlation analysis
  if (sum(numeric_columns) >= 2)  {
    correlation_matrix <- cor(numeric_data)
    
    # Store the correlation matrix in the list with the category as the name
    correlation_matrices[[category]] <- correlation_matrix
  } else {
    cat("Insufficient numeric columns for correlation analysis in", commodity_name, "\n")
  }
}

# Visualize correlations for each category
for (category in names(correlation_matrices)) {
  cat("\nCategory:", category)
  corrplot(correlation_matrices[[category]], method = "color", type = "lower", tl.col = "black", title = "Correlation Heatmap")
}


```

```{r}
# Define a function to categorize commodities
categorize_commodity <- function(commodity_name) {
  if (commodity_name %in% c("Cotton", "Coffee", "Sugar", "Cocoa", "Corn", "SoyBeans", "SoyOil", "SoyMeal", "Wheat", "LeanHogs")) {
    return("Agricultural Commodities")
  } else if (commodity_name %in% c("FedCattle", "LiveCattle", "LeanHogs")) {
    return("Livestock")
  } else if (commodity_name %in% c("Copper", "Gold", "Silver", "Platinum", "Palladium")) {
    return("Metals")
  } else if (commodity_name %in% c("CrudeOil", "NagGas", "HeatOil", "Gasoline")) {
    return("Energy Commodities")
  } else {
    return("Other")
  }
}

# Create a list to store correlation matrices for each category
correlation_matrices <- list(
  "Agricultural Commodities" = NULL,
  "Livestock" = NULL,
  "Metals" = NULL,
  "Energy Commodities" = NULL
)

category_commodities <- list(
  "Agricultural Commodities" = list(),
  "Livestock" = list(),
  "Metals" = list(),
  "Energy Commodities" = list(),
  "Other" = list()
)

#Building lists with commodities within categories
for (commodity in names(commodity_data_list)){
  current_category = categorize_commodity(commodity)
  category_commodities[[current_category]] <- append(category_commodities[[current_category]], commodity)
}


# Loop through the data frames
for (current_category in names(category_commodities)) {
  for(current_commodity in category_commodities[[current_category]]){
    my_data = commodity_data_list[[current_commodity]] %>% data.frame() %>% select(-Date)
  
    cormat = round(cor(my_data),2)
    melted_cormat <- melt(cormat) %>% rename("Variable_1"="Var1", "Variable_2"="Var2")
    plot = ggplot(data = melted_cormat, aes(x=Variable_1, y=Variable_2, fill=value)) +
    ggtitle(paste("Correlation heatmap", current_commodity))+
    geom_tile(color = "white") +
    scale_fill_gradient2(high = "darkblue", low = "darkred", mid = "white", midpoint = 0, limit = c(-1,1), space = "Lab", name="Pearson\nCorrelation") +
    theme_minimal()+ 
    theme(axis.text.y = element_text(size=7))+
    theme(axis.text.x = element_text(angle = 40, vjust = 1, size = 7, hjust = 1))+
    coord_fixed()
    print(plot)
  }
}


```

We change the Date variable to consecutive integers because of its irregularity. This modification will help us to manipulate and analyse time series.
```{r}

# Create a new list to store data frames with modified dates
commodity_data_list_modified <- list()

# Iterate through the original list and create a modified copy
for (commodity in commodities) {
  # Make a copy of the data from the original list
  data_copy <- data.frame(commodity_data_list[[commodity]])
  
  # Modify the Date column to consecutive integers
  data_copy$Date <- 1:nrow(data_copy)
  
  # Store the modified data in the new list
  commodity_data_list_modified[[commodity]] <- as_tsibble(data_copy, index = Date, regular = FALSE)
}


```

Then we standardize our data.

```{r}
# Create a new list to store standardized data frames
standardized_commodity_data_list <- list()

# Iterate through the modified data list and standardize each data frame
for (commodity in commodities) {
  # Get the modified data from the modified list
  modified_data <- commodity_data_list_modified[[commodity]]
  
  # Standardize the data excluding the "Date" column
  standardized_data <- scale(modified_data[, -1])
  
  # Create a new data frame with standardized values
  standardized_data_frame <- as.data.frame(standardized_data)
  
  # Add back the "Date" column
  standardized_data_frame$Date <- modified_data$Date
  
  # Convert to tsibble
  tsibble_data <- as_tsibble(standardized_data_frame, index = Date, regular = FALSE)
  
  # Store the standardized data in the new list
  standardized_commodity_data_list[[commodity]] <- tsibble_data
}

```

Covariance matrix:

```{r}
# Create a new list to store covariance matrices
covariance_matrices_list <- list()

# Iterate through the standardized data list and calculate the covariance matrix
for (commodity in commodities) {
  # Get the standardized data from the standardized list
  standardized_data <- standardized_commodity_data_list[[commodity]]
  
  # Exclude the "Date" column
  trading_vars <- as.matrix(standardized_data[, -17])
  
  # Calculate the covariance matrix
  cov_matrix <- cov(trading_vars)
  
  # Store the covariance matrix in the new list
  covariance_matrices_list[[commodity]] <- cov_matrix
}

covariance_matrices_list
```

PCA 


```{r}
# Create a new list to store PCA results
pca_results_list <- list()

# Iterate through the covariance matrices and perform PCA
for (commodity in commodities) {
  # Get the covariance matrix from the list
  cov_matrix <- covariance_matrices_list[[commodity]]
  
  # Perform PCA using prcomp
  pca_result <- prcomp(cov_matrix, scale. = TRUE)
  
  # Store the PCA result in the new list
  pca_results_list[[commodity]] <- pca_result
}

pca_results_list

```

SCREE PLOTS

```{r}
# Create a new list to store scree plots
scree_plots_list <- list()

# Iterate through the PCA results and create scree plots
for (commodity in commodities) {
  pca_result <- pca_results_list[[commodity]]
  
  # Extract eigenvalues
  eigenvalues <- pca_result$sdev^2
  
  # Create scree plot
  scree_plot <- plot(1:length(eigenvalues), eigenvalues, type = "b", 
                     main = paste("Scree Plot -", commodity),
                     xlab = "Principal Component", ylab = "Eigenvalue")
  
  # Store the scree plot in the list
  scree_plots_list[[commodity]] <- scree_plot
}

scree_plots_list
```

BIPLOTS
```{r}
# Create a new list to store biplots
biplots_list <- list()

# Iterate through the PCA results and create biplots
for (commodity in commodities) {
  pca_result <- pca_results_list[[commodity]]
  
  # Create biplot
  biplot <- biplot(pca_result, scale = 0)
  
  # Add title to the biplot
  title <- paste("Biplot -", commodity)
  title(main = title)
  
  # Store the biplot in the list
  biplots_list[[commodity]] <- biplot
}

biplots_list
```



We want to retain the principal components associated with eigenvalues above the "elbow" in the scree plot.

VARIABLES SELECTION = ASK Professor BOLDI FOR THE METHOD PLS

```{r}
# Create a new list to store the most significant variables
most_significant_variables_list <- list()

# Iterate through the PCA results
for (commodity in commodities) {
  pca_result <- pca_results_list[[commodity]]
  
  # Extract loadings from the PCA result
  loadings <- pca_result$rotation
  
  # Identify the most significant variable for each principal component
  most_significant_variables <- apply(loadings, 2, function(pc_loadings) {
    variable_index <- which.max(abs(pc_loadings))
    variable_name <- colnames(loadings)[variable_index]
    return(variable_name)
  })
  
  # Store the most significant variables in the list
  most_significant_variables_list[[commodity]] <- most_significant_variables
}

# Print or use the most significant variables list as needed
print(most_significant_variables_list)

```
The labels "PC14," "PC5," etc., are likely the names or labels of the original variables in your dataset. These labels indicate which variables contribute the most to the variability captured by each principal component.

NUMBER OF PCA TO SELECT


```{r}
# Create a list to store the cumulative variance explained for each commodity
cumulative_variance_explained_list <- list()

# Iterate through the PCA results
for (commodity in commodities) {
  pca_result <- pca_results_list[[commodity]]
  
  # Access eigenvalues and calculate cumulative variance
  eigenvalues <- pca_result$sdev^2
  cumulative_variance <- cumsum(eigenvalues) / sum(eigenvalues)
  
  # Store the cumulative variance explained in the list
  cumulative_variance_explained_list[[commodity]] <- cumulative_variance
}

# Select the number of principal components based on cumulative variance explained
# Adjust the threshold as needed
threshold <- 0.95
selected_components_list <- lapply(cumulative_variance_explained_list, function(cum_var) {
  which(cum_var >= threshold)[1]
})

# Print or use the selected components list as needed
print(selected_components_list)

```

```{r}
library(tsibble)
library(fable)
library(ggplot2)

# Assuming COT_Cotton is your tsibble
# Assuming you have a column 'Open_Interest' and 'Date'

# Convert 'Date' to Date format
COT_Cotton$Date <- as.Date(COT_Cotton$Date)

# Create a tsibble with regular dates starting from January 2006
regular_tsibble <- tsibble(date = seq(from = as.Date("2006-01-01"), by = "1 week", length.out = nrow(COT_Cotton)))

# Merge COT_Cotton and regular_tsibble based on nothing
merged_data <- bind_cols(COT_Cotton %>% select(-Date), regular_tsibble)

merged_data <- as.tsibble(merged_data)

# Fit the ETS model using the merged data
fit <- merged_data %>%
  model(ETS(`Open Interest` ~ error("A") + trend("N") + season("N")))

# Forecast for the next 5 observations
fc <- fit %>%
  forecast(h = 5)

# Merge the forecasts onto the regular dates
merged_data_forecast <- bind_cols(regular_tsibble, as_tibble(fc))

# Plot the forecast
autoplot(merged_data_forecast, aes(x = date, y = `Open Interest`)) +
  geom_line(aes(y = .fitted), col = "#D55E00") +
  labs(y = "Open Interest", title = "Forecast: Cotton Open Interest") +
  guides(colour = "none")





```

